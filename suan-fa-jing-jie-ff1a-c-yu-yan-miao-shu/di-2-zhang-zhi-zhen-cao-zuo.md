# 第2章 指针操作

## 指针基础

理解指针的最佳方法：画图表。

用来理解指针的最好方法之一就是绘制图表。指针通常都是按位置用箭头一个一个连接起来，而不是在图表中画出实际的地址。当指针不指向任何数据，也就是说指针被设置成NULL时，用两条竖线来表示。

![](/assets/WX20170406-230819@2x.png)图2-1 指针操作的图例

## 存储空间分配

存储空间分配是指在内存中预留存储空间的过程。理解指针与内存分配是密不可分的非常重要，当通过指针访问内存时，其意义就如同一个虚拟的菜谱一样，指针〈内存地址）对应菜名，其所指向的内存空间中的数据对应实际的菜。

通常情况下指针会占用一个机器字长的存储空间，但有些时候它们的大小也有

所不同。因此，为了保证代码的可移植性，不应该假设每个指针都占有一个特定大小的存储空间。指针变量的大小通常与编译器的设定以及某些特定的c实现中的类型界定符有关。必须要记住的一点是：当声明一个指针时，仅仅只是为指针本身分配了空间，并没有为指针所引用的数据分配空间。而为数据分配存储空间有两种方法：一种是直接声明一个变量；另一种是在运行时动态地分配存储空间。

在C语言中，当想要动态分配存储空间时，我们会得到一个指向一个堆存储空间的指针。此存储空间由我们自行管理，并且会一直存在，除非我们显式地调用函数free将它释放。

## 数据集合与指针的算术运算

在c语言中，数据集合主要指结构和数组。在c中，数组和指针一样，都是以指针算术运算的方法进行运算的。

c语言支持两种数据集合：结构和数组。（虽然联合与结构类似，但一般它单独被归为一类。）

### 结构

结构通常是由各种各样的有序的元素组成的，从而它可以被看做单个连续的数据类型。结构指针是构建一个数据结构的重要组成部分。结构使我们能把数据捆绑在一起，指针使我们能够让这些捆绑包在内存中一个一个连接起来。用这些连接起来的结构，我们可以对它们加以组织并用来解决实际的问题。

结构ListElmt也指出了关于结构指针的另一个重要方面：**结构不允许包含自身的实例，但可以包含指向自身实例的指针。**这种编程思想非常重要，因为很多数据结构都可能是由它自身的结构变量所组成，例如，在一个链表中，每个ListElmt结构都指向另一个ListElmt结构。有些数据结构甚至会包含多个由自身结构类型组成的结构，例如，在一个二叉树中\(见第9章），每个节点同时指向其他两个二叉树的节点。

### 数组

数组是在内存中连续排列的同类元素的序列。在C语言中，数组与指针密不可分。事实上，当一个数组标识符在表达式中出现时，c语言显然会把数组转换为一个指向数组第一个元素的固定指针。

## 作为函数参数的指针

通过这种方式，可以按照传递引用的方法传递函数参数。在c语言中，传递数组或大型结构时，使用指针是一种普遍而高效的方法。

在c语言的函数调用中指针起着至关重要的作用。最重要的是，**指针支持将参数作为引用传递给函数（即按引用调用）。按引用传递参数时，当函数改变此参数时，这个被改变参数的值会一直存在，甚至函数退出后都仍然存在。相对而言，当按值调用传递函数时，此时值的改变只能持续到函数返回时。**无论是否要改变函数的输人输出参数，使用指针传递大容量复杂的函数参数也是十分高效的手段。这种方法高效的原因就在于，我们只是传递一个指针而不是一个数据的完整副本到函数中，这样可以大大地节省内存空间。本书中多处都用到了这种方法。

### 按引用调用传递参数

在形式上，c语言只支持按值来传递参数。在按值调用传递参数的过程中，函数参数的一份私有副本将会用到函数的执行体中。然而，我们可以模仿接引用调用传递参数将一个指向参数的指针〈而不是参数本身）传递给函数，这样函数调用者就可以得到一个指针的私有副本用于函数体的执行过程。

要了解按引用调用是如何现实的，我们来看看swap1。是一个实现将两个整型变量相互交换的函数，函数参数是通过按值调用传递的，所以得到的结果是错误的。图2-4说明了为什么交换函数不起作用。swap2同样是一个交换函数，只是它的参数是按引用调用传递的。图2-5说明如何使用指针来修正swap1中的错误。

错误的交换

```c
void swap1(int x, int y) {
int tmp;
tmp = x; x = y; y = tmp;
return;
}
```

正确的交换

```c
void swap2(int *x, int *y) {
int tmp; tmp=*x;*x=*y;*y=tmp;
return;
}
```

![](/assets/WX20170406-231216@2x.png)图2-4：按值调用传参数的swap1函数的运行过程，不能交换调用者环境中两个整数的值

![](/assets/WX20170406-231316@2x.png)图2-5：按引用调用传递参数的swap2函数的运行过程，成功交换调用者环境中两个整数的值

## 作为参数指向指针的指针

这是一种指向指针的指针，而不是指向具体变量的指针。

移除由list指定的链表中element后的那个元素。如果element设置为NULL，则

移除链表头元素。调用返回后，data指向已移除元素中存储的数据。由调用者负责管理data所引用的存储空间。

```c
int list_rem_next(List *list, ListElmt *element, void **data);
```

由于此函数需要改变data使data指向被删除的那个元素，因此必须将指针data的地址传递给函数以模仿按引用传递参数（见图2-7）。所以，函数接受一个指向指针的指针作为它的第三个参数。在本书中，这是一个用来删除数据结构中数据的典型方法。

![](/assets/WX20170406-231441@2x.png)图2-7：函数改变指向指针的指针的过程

## 函数指针

指针指向可执行代码段或指向调用可执行代码段的信息块，而不是指向某种具体数据。它们把函数当做一小段数据来存储和管理。

